<section id="sec-5-finalised">
  <h2 class="section-title">5. Finalised Main Design Concept Validation and Prototyping</h2>

      <img src="images/final.png" alt="Prototype Photo" style="width: 50%; display:block; margin:auto;">
<p style="text-align:center; margin-top:6px;">
  <strong>Figure X:</strong> Explanation put here.
</p>

 <div class="video-wrap">
    <video class="small-video" autoplay muted loop playsinline controls>
        <source src="videos/explode.mp4" type="video/mp4" />
    </video>
</div>
<p style="text-align:center; margin-top:6px;">
  <strong>Video X:</strong> Explanation put here.
</p>


  <!-- ========================================================= -->
  <!-- 5.1 ROBOT DYNAMIC MOTION CONCEPT -->
  <!-- ========================================================= -->
  <h3 class="subsection-title" id="sec-5-1">5.1 Robot Dynamic Motion Concept</h3>


  <p>
    There are two ways the big wheel robot can climb up the 200mm step. Both ways are illustrated below in Figure X. <br>
    1. Putting The robot body on the platform before bringing the leg over the platform. 
    <br>
    2. Jump up, the wheel will have a little or no contact with the platform edge before roll up the platform completely
  </p>

     <img src="images/first.jpg" alt="Prototype Photo" style="width: 100%; display:block; margin:auto;">
     <img src="images/second.jpg" alt="Prototype Photo" style="width: 100%; display:block; margin:auto;">

<p style="text-align:center; margin-top:6px;">
  <strong>Figure X:</strong> Explanation put here.
</p>





  <!-- ========================================================= -->
  <!-- 5.2 LINKAGE DESIGN AND CALCULATION -->
  <!-- ========================================================= -->
  <h3 class="subsection-title" id="sec-5-2">5.2 Linkage Detailed Design</h3>
<p>
In this section, the detailed design of the linkage mechanism used in the wheel-leg configuration is presented. 
The linkage is critical for enabling effective step-climbing capability while optimising torque transmission and structural integrity.
</p>





  <!-- 5.2.1 -->
  <h4 class="subsubsection-title" id="sec-5-2-1">5.2.1 Design Consideration</h4>

  <p>
    The linkage is used to create a <strong>torque step-up</strong> based on the ratio between the
    linkage arms (for example, segments CD and CE in the design). A scissor-type five-bar
    configuration is adopted because it offers a much wider tuning range for this ratio compared
    to conventional linkages mounted behind the wheel, which only provide limited
    mechanical amplification.
  </p>

  <p>
    By adjusting pivot positions and arm lengths, the scissor layout allows a higher and more
    controllable torque multiplier specifically in the step-climbing posture. This produces a
    stronger lifting moment at the wheel–step contact while keeping linkage forces within
    realistic material limits. At this stage, the design mainly targets <strong>static load-carrying
    capability</strong> to ensure the robot can hold its weight on a step without back-driving.
  </p>




  <!-- 5.2.2 -->
  <h4 class="subsubsection-title" id="sec-5-2-2">5.2.2 Design Validation</h4>

  <p>
    At this stage, validation focuses on the linkage’s <strong>static load capacity</strong> under the
    motor’s holding torque. The objective is to confirm that, in a step-climbing
    posture, the linkage can safely support the full robot weight with a comfortable
    safety margin.
  </p>

  <div class="math-image-container">
          <img src="images/Linkage Calculation.jpg" alt="Linkage Calculation Diagram"style="width: 80%; display:block; margin:auto;" />
        </div>
    <p style="text-align:center; margin-top:6px;">
        <strong>Figure X:</strong> Linkage geometry
  <details class="expand-box">
  <summary><strong>Click to expand: Full linkage length calculation page</strong></summary>

  <div class="iframe-wrap" style="margin-top:12px;">
    <iframe
      src="Linkage Calculations.html"
      loading="lazy"
      style="
        width: 100%;
        height: 1100px;
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      "
    ></iframe>
  </div>

  <p style="text-align:center; margin-top:6px;">
    <strong>Figure X:</strong> Embedded linkage length calculation page showing
    static equilibrium derivation, MATLAB parametric sweep, and torque–weight
    maps for different link configurations.
  </p>
</details>



  <p>
    From the calculation results, many configurations satisfy the 200&nbsp;mm step requirement
    while delivering a static lift capacity exceeding approximately <strong>38&nbsp;kg</strong>, which gives a
    robust safety margin for the current <strong>20&nbsp;kg</strong> robot. These static approximations provide
    a sufficiently conservative reference during the rapid prototyping phase. 

    <br><br>
    For this project, a ratio of  <strong>cd/ce = 115/75 ≈ 1.5</strong> was selected for design and packaging convenience.
  </p>

<img src="images/linkage distance.jpg" alt="Prototype Photo" style="width: 80%; display:block; margin:auto;">
<p style="text-align:center; margin-top:6px;">
    <strong>Figure X:</strong> Linkage dimension diagram showing key lengths and pivot locations.           
</p>

<p> 
The linkage allows a maximum travel of 448 - 137 = 311mm, which is 
sufficient for the robot to climb the 200mm step while maintaining a reasonable posture.

</p>

  <!-- 5.2.4 -->
  <h4 class="subsubsection-title" id="sec-5-2-4">5.2.4 Prototyping</h4>

<img src="images/linkage.jpg" alt="Prototype Photo" style="width: 50%; display:block; margin:auto;">
<p style="text-align:center; margin-top:6px;">  
    <strong>Figure X:</strong> Explanation put here.
</p>

  <p>
    A first prototype of the linkage was manufactured using 3D print plate and standard
    fasteners to quickly verify motion and interference clearance. This
    prototype focuses on:
  </p>

  <ul>
    <li>Checking the real motion envelope against the CAD model.</li>
    <li>Confirming there is no collision with the wheel, chassis or armour.</li>
    <li>Varify the dynamic capability.</li>
    <li>Allow the prototype to execute some balancing motion with the motors installed.</li>
  </ul>




  <!-- 5.2.5 -->
  <h4 class="subsubsection-title" id="sec-5-2-5">5.2.5 Future Improvements – Linkage</h4>

  <ul>
    <li>Perform full dynamic simulation to identify the most energy-efficient linkage profile for repeated step climbing.</li>
    <li>Use FEA to determine the required plate thickness and verify stiffness and strength under worst-case loads.</li>
    <li>Optimise joint hardware and countersink depths to eliminate unwanted looseness caused by over-long bolts.</li>
    <li>Select suitable structural materials (e.g., aluminium vs. carbon fibre) while avoiding geometries that promote carbon fibre delamination.</li>
    <li>Justify any weight-reduction pockets using FEA to ensure no local overstress is introduced.</li>
    <li>Add wire-routing holes and dedicated mounting points for motor drivers and sensors to improve integration and serviceability.</li>
  </ul>



  <!-- ========================================================= -->
  <!-- 5.3 CASCADED LEG JOINT DESIGN -->
  <!-- ========================================================= -->
  <h3 class="subsection-title" id="sec-5-3">5.3 Cascaded Leg Joint Design</h3>

<img src="images/cascaded.png" alt="Prototype Photo" style="width: 100%; display:block; margin:auto;">
<p style="text-align:center; margin-top:6px;">
    <strong>Figure X:</strong> Cascaded joint diagram showing key components and layout.
</p>

<video class="small-video" autoplay muted loop playsinline controls>
    <source src="videos/cascaded.mp4" type="video/mp4" />
</video>
<p style="text-align:center; margin-top:6px;">
    <strong>Video X:</strong> Explanation put here.
</p>

  <!-- 5.3.1 -->
  <h4 class="subsubsection-title" id="sec-5-3-1">5.3.1 Design Consideration</h4>

 <p>
  Although many robots stack hip and knee motors using hollow-shaft actuators for compactness, 
  hollow-shaft units are far more expensive. The HT8101 motors used in this project cost about 
  $300 SGD each, whereas comparable hollow-core motors are typically several times more.
  <br><br>
  Using non-hollow motors also enables mounting one at the front and one at the rear of the 
  chassis, improving mass distribution and reducing the load concentration that occurs when 
  stacked motors sit at a single joint.
  <br><br>
  To realise this layout, a cascaded-joint architecture is adopted. This design allows two 
  freely rotating gears to share the same axle, each driving the large and small leg segments 
  independently, as demonstrated in the video.
</p>


  <!-- 5.3.2 -->
  <h4 class="subsubsection-title" id="sec-5-3-2">5.3.2 Design Details</h4>

  <img src="Other Images/Bearing Drawing.jpg" alt="Prototype Photo" style="width: 80%; display:block; margin:auto;">
  <img src="Other Images/Cascaded Bearing Assembly.jpg" alt="Prototype Photo" style="width: 80%; display:block; margin:auto;">
<p style="text-align:center; margin-top:6px;">
    <strong>Figure X:</strong> Sectioned view of the cascaded joint assembly showing key components and tolerances. 
</p>


  <p>
    The cascaded joint comprises:
  </p>

  <ul>
    <li>Two drive stages using chains and sprockets to route torque to the big and small leg segments.</li>
    <li>A central support structure that houses the 4 headset bearing and chain paths.</li>
    <li>Carefully controlled fabrication tolerances to minimise backlash and misalignment.</li>
  </ul>

  <p>
    Fabrication tolerance is critical: too much clearance introduces backlash and vibration,
    while too little makes assembly difficult. The joint geometry is therefore designed with
    explicit allowance for machining and anodising while keeping functional fits tight in
    high-load regions.
  </p>

<img src="Other Images/Headset bearing photo.jpg" alt="Prototype Photo" style="width: 50%; display:block; margin:auto;">
<p style="text-align:center; margin-top:6px;">
    <strong>Figure X:</strong> headset bearing.
</p>    

  <p>
    The main joint bearing is a <strong>1.8″ bicycle headset angular-contact bearing</strong> with nominal
    size <strong>47.8 × 56.8 × 6.5&nbsp;mm (ACB568H6.5-type)</strong>, chosen primarily for its compact
    form factor and convenient integration with circular housings.
  </p>


  <!-- 5.3.3 -->
  <h4 class="subsubsection-title" id="sec-5-3-3">5.3.3 Design Validation</h4>

  <p>
    Although the exact load rating of the 47.8 × 56.8 × 6.5&nbsp;mm ACB568H6.5 headset bearing
    is not published by the vendor, a comparable headset bearing (Enduro ACB&nbsp;4545&nbsp;150,
    40&nbsp;×&nbsp;52&nbsp;×&nbsp;7&nbsp;mm) has a static load rating of approximately <strong>4.34&nbsp;kN</strong>.
    the headset bearing is considered significantly over-specified for this application.
  </p>

  <p>
    As a result, the bearing choice is driven almost purely by geometric constraints and
    packaging rather than by ultimate load capacity.
  </p>


  <!-- 5.3.4 -->
  <h4 class="subsubsection-title" id="sec-5-3-4">5.3.4 Prototyping</h4>

  <img src="Other Images/photo_6105138025646983937_y (2).jpg" alt="Prototype Photo" style="width: 50%; display:block; margin:auto;">
  <img src="Other Images/photo_6105138025646983938_y (1).jpg" alt="Prototype Photo" style="width: 50%; display:block; margin:auto;">
<p style="text-align:center; margin-top:6px;">
    <strong>Figure X:</strong> Explanation put here.    
</p>

  <p>
    A metal prototype of the cascaded joint was manufactured and assembled with the
    selected bearing, sprockets and chain. The prototype demonstrates:
  </p>

  <ul>
    <li>Smooth rotational motion over the full operating range.</li>
    <li>Acceptable backlash for the current stage of development.</li>
    <li>No obvious binding, scraping or structural instability under manual loading.</li>
  </ul>

 


  <!-- 5.3.5 -->
  <h4 class="subsubsection-title" id="sec-5-3-5">5.3.5 Future Improvements – Cascaded Joint</h4>

  <p>
    The Cascaded Joint works as intended and quite smoothly with undetectable vibration and noise. No future improvements are needed. 
  </p>



  <!-- ========================================================= -->
  <!-- 5.4 HUBLESS WHEEL DESIGN -->
  <!-- ========================================================= -->
  <h3 class="subsection-title" id="sec-5-4">5.4 Hubless Wheel Design</h3>

<img src="images/hubless.jpg" alt="Prototype Photo" style="width: 80%; display:block; margin:auto;">
<p style="text-align:center; margin-top:6px;">
    <strong>Figure X:</strong> Explanation put here.    
</p>

  <!-- 5.4.1 -->
  <h4 class="subsubsection-title" id="sec-5-4-1">5.4.1 Design Consideration</h4>

<p>
The hubless wheel design was chosen due to RoboMaster competition rules,
 which require rigid “armour plates” to be mounted on all four sides of the robot. 
 These plates must remain at a fixed height and stay horizontally aligned relative to the chassis during motion.

 <br><br>

This constraint makes it difficult to use large conventional wheels in a bipedal wheel-leg configuration, 
as the armour plates would significantly obstruct the leg’s movement(Refer to Figure X (Right). A hubless wheel avoids this interference, 
allowing the leg to articulate freely while still meeting the competition’s armour-mounting requirements.
</p> 

<img src="images/rule.jpg" alt="Prototype Photo" style="width: 80%; display:block; margin:auto;">
<p style="text-align:center; margin-top:6px;">
    <strong>Figure X:</strong> Explanation put here.    
</p>

  <p>
  Given the design constraints, a hubless wheel configuration was selected. Although uncommon due 
  to higher bearing friction, reduced structural rigidity, and the need for a fully customised 
  wheel–hub interface, the design offers a key advantage: it allows a significantly lower chassis 
  profile. This provides much greater flexibility for integrating the gimbal within competition 
  height limits and, importantly, enables the armour plate to be mounted rigidly at the centre of 
  the wheel’s non-rotating inner frame.
</p>


  <!-- 5.4.2 -->
  <h4 class="subsubsection-title" id="sec-5-4-2">5.4.2 Design Details</h4>

 <img src="images/turn table.jpg" alt="Prototype Photo" style="width: 80%; display:block; margin:auto;">
<p style="text-align:center; margin-top:6px;">
    <strong>Figure X:</strong> Explanation put here.
</p>

  <p>
    The current design uses a large turntable bearing as the inner raceway, with a
    3D-printed gear profile attached to the wheel rim for prototyping. The inner non-rotating
    frame mounts directly to the cascaded leg joint, and the outer ring acts as the driven
    wheel. (Refer to Figure X)
  </p>

  <!-- 5.4.3 -->
  <h4 class="subsubsection-title" id="sec-5-4-3">5.4.3 Design Validation</h4>

  <p>
    Kinematic calculations were carried out using the selected motor (e.g. M3508) and gear
    ratio to ensure that the hubless wheel can deliver sufficient tangential speed and
    acceleration on flat ground and during step climbing. These checks confirm that the
    prototype meets the required speed range while staying within realistic torque limits using the available motor.
  </p>

  <video class="small-video" autoplay muted loop playsinline controls>
    <source src="videos/inner outer.mp4" type="video/mp4" />
</video>
<p style="text-align:center; margin-top:6px;">  
    <strong>Figure X:</strong> Explanation put here.    
</p>




<details class="expand-box">
    <summary><strong>Click to expand: Hubless Wheel Acceleration calculation</strong></summary>

<img src="images/motor.jpg" alt="Prototype Photo" style="width: 50%; display:block; margin:auto;">
<p style="text-align:center; margin-top:6px;">
    <strong>Figure X:</strong> Explanation put here. 

</p>

    <p>
    This configuration of Standard ISO involute gear profile 13 teeth to 43 teeth gives a torque step up of 3.3 times. 
    </p>


<img src="images/calc.png" alt="Prototype Photo" style="width: 100%; display:block; margin:auto;">
<p style="text-align:center; margin-top:6px;">
    <strong>Figure X:</strong> Explanation put here.   
    </p>


</details>

<p> 
  The acceleration from the calculation ~4m/s^2 is sufficient for prototyping purpose. The gear ratio can be optimised to suit future needs. 
</p>

  <!-- 5.4.4 -->
  <h4 class="subsubsection-title" id="sec-5-4-4">5.4.4 Prototyping</h4>
<img src="Other Images/gif2.gif" alt="Prototype Photo" style="width: 100%; display:block; margin:auto;">
<p style="text-align:center; margin-top:6px;">
    <strong>Figure X:</strong> Explanation put here. 
</p> 


  <p>
    Due to time constraints, the hubless wheel prototype was built using a
    <strong>350&nbsp;mm-diameter turntable</strong> and a 3D-printed gear profile. This is not a production-grade
    solution, but it is sufficient to:
  </p>

  <ul>
    <li>Verify the feasibility of the hubless geometry.</li>
    <li>Test smooth rotational motion under light load.</li>
    <li>Check assembly and integration with the leg structure.</li>
  </ul>



  <!-- 5.4.5 -->
  <h4 class="subsubsection-title" id="sec-5-4-5">5.4.5 Future Improvements - Hubless Wheel</h4>

  <ul>
    <li>
      Replace the temporary turntable with a bearing specifically designed for radial loads.
      The current turntable risks ball jamming under high radial forces.
    </li>
    <li>
      Perform dynamic modelling of the gear train to determine the optimal gear ratio with
      respect to the motor torque and desired speed.
    </li>
    <li>
      Simplify and stiffen the mounting structure between the inner frame and the leg;
      several intermediate pieces are currently used only to “fit” the wheel-leg assembly and
      can be eliminated.
    </li>
    <li>
      Increase overall structural rigidity to reduce flex, which would otherwise degrade
      control performance.
    </li>
  </ul>



  <!-- ========================================================= -->
  <!-- 5.5 CHAIN DRIVE MECHANISM -->
  <!-- ========================================================= -->
  <h3 class="subsection-title" id="sec-5-5">5.5 Chain Drive Mechanism</h3>

 <div class="video-wrap">
    <video class="small-video" autoplay muted loop playsinline controls>
        <source src="videos/chain.mp4" type="video/mp4" />
    </video>
</div>

  <!-- 5.5.1 -->
  <h4 class="subsubsection-title" id="sec-5-5-1">5.5.1 Design Consideration</h4>

  <p>
    The chain drive is used to offset the drive motor to the side of the leg while still
    transmitting torque to the hubless wheel and cascaded joints. This improves packaging
    flexibility and keeps the motor away from direct impact zones.
  </p>

  <img src="images/image16.png" style="width: 50%; display:block; margin:auto;">
<p style="text-align:center; margin-top:6px;">
    <strong>Figure X:</strong> 8 Speed Bicycle Chain
</p>


  <p>
    A lightweight bicycle-type chain is selected rather than a standard industrial roller chain,
    as bicycle chain are much thinner and light weight.
  </p>


  <!-- 5.5.2 -->
  <h4 class="subsubsection-title" id="sec-5-5-2">5.5.2 Design Details</h4>

  <p>
    The chain drive consists of:
  </p>

  <ul>
    <li>Primary drive sprocket on the motor output shaft.</li>
    <li>Driven sprocket on the hubless wheel / intermediate shaft.</li>
    <li>A small roller acting as a chain tensioner.</li>
  </ul>

  <img src="Other Images/Tensioning 1.jpg" style="width: 50%; display:block; margin:auto;">
   <img src="Other Images/Tensioning 2.jpg" style="width: 50%; display:block; margin:auto;">
<p style="text-align:center; margin-top:6px;">
    <strong>Figure X:</strong> Chain Tensioner
</p>

  <p>
    Currently, a small bicycle roller is installed to tension the chain. However, its position is
    fixed, so the tension cannot be adjusted once assembled.
  </p>

<img src="images/gear drawing 1.jpg" alt="Prototype Photo" style="width: 70%; display:block; margin:auto;">
<img src="images/gear drawing 2.jpg" alt="Prototype Photo" style="width: 70%; display:block; margin:auto;">
<p style="text-align:center; margin-top:6px;">
    <strong>Figure X:</strong> FILL IN 

<p> 
  The gear is designed to follow the standard ISO Involute profile: ISO Z16 08A. 
</p>



  <!-- 5.5.3 -->
  <h4 class="subsubsection-title" id="sec-5-5-3">5.5.3 Design Validation</h4>

  <p>
    The mechanical strength of the selected chain is a typical bicycle chain which can withstand up to 200kg, it significantly exceeds the torque produced
    by the drive motor, even under conservative shock-load assumptions. 

    <br><br>

    The mechanical advantage of the chain sprocket is not considered yet as the current prototype is only used to verify the chain routing and tensioning concept.
    Optimisation will be considered in the future after the mechanical parametres are more finalised.
  </p>

  <!-- 5.5.4 -->
  <h4 class="subsubsection-title" id="sec-5-5-4">5.5.4 Prototyping</h4>

<div class="video-wrap">
    <video class="small-video" autoplay muted loop playsinline controls>
        <source src="videos/chain2.mp4" type="video/mp4" />
    </video>
</div>


  <p>
    A prototype chain drive was assembled on the leg module and tested for:
  </p>

  <ul>
    <li>Chain tracking and alignment across the full range of motion.</li>
    <li>Noise and vibration under moderate load.</li>
    <li>Ease of assembly and chain installation.</li>
  </ul>

  <p>
    It is shown in the video that the chain is very loose and need to be tensioned properly.
  </p>

  <!-- 5.5.5 -->
  <h4 class="subsubsection-title" id="sec-5-5-5">5.5.5 Future Work - Chain Drive</h4>

  <p>
    Implement a <strong>screw-adjustable tensioning mechanism</strong> so that chain tension can be
    tuned precisely during assembly and maintenance. The mounting brackets for both the
    tensioner and the sprockets should be stiffened and simplified to minimise play, which
    will improve drivetrain efficiency and reduce backlash.
  </p>



  <!-- ========================================================= -->
  <!-- 5.6 – 5.8 PLACEHOLDERS (IF YOU WANT TO KEEP THEM) -->
  <!-- ========================================================= -->
  <h3 class="subsection-title" id="sec-5-6">5.6 Electrical</h3>

  <p>

     Owing to project budget limitations, motors supplied by the NUS Calibur team are used 
  in this design. Prior calculations have already verified that these motors meet the 
  performance requirements for the intended application.

  </p>
  
<details class="expand-box">
    <summary><strong>Click to expand: Motors Used</strong></summary>
    
<img src="images/HT8108.jpg" alt="Electrical Diagram" style="width: 50%; display:block; margin:auto;">
<p style="text-align:center; margin-top:6px;">
    <strong>Figure X:</strong> HT8108-J6 Joint Motor 
</p>

<p>
    Nominal Torque = 6Nm 
    <br>
    Torque After Reduction = 36Nm (with 1:6 reduction)
    <br>
    Max Speed After Reduction = 440 RPM
    <br>
    Nominal Current = 15A 
    <br>
    Voltage Range = 24V - 36V
    <br>
    Power = 170W 
</p>

<img src="images/M3508.jpg" alt="Electrical Diagram" style="width: 50%; display:block; margin:auto;">
<p style="text-align:center; margin-top:6px;">
    <strong>Figure X:</strong> M3508-P9 Wheel Motor
</p>

<p>

    Torque After Reduction = 3Nm (with 1:6 reduction)
    <br>
    Max Speed After Reduction = 469 RPM
    <br>
    Nominal Current = 15A 
    <br>
    Voltage Range = 24V
</p>


    

</details>



  <h3 class="subsection-title" id="sec-5-7">5.7 Firmware Code</h3>
  
<p>
  Firmware development will be the primary focus moving forward. At the current stage, it is 
  implemented mainly to test integration with the mechanical and electrical systems and to 
  establish a foundation for future development.
</p> 

<details class="expand-box">
    <summary><strong>Click to expand: Firmware Code implmented to test the prototype</strong></summary>
    
    <p> 
Below are example code snippets for the balancing control loop implemented in the robot's firmware. It is used to test 
the responsiveness of the Hubless Wheel to the IMU data to try to keep the robot balance with PID first.

    </p>

    <div class="code-block">
        <pre><code class="language-c">
void balance_init(void)
{
    // Angle PID
    bal_angle_pid.kp = 20.0f;
    bal_angle_pid.ki = 0.01f;
    bal_angle_pid.kd = 1.0f;
    bal_angle_pid.max_out = 8000.0f;
    bal_angle_pid.int_max = 1000.0f;
    bal_angle_pid.error[0] = 0.0f;
    bal_angle_pid.error[1] = 0.0f;
    bal_angle_pid.integral = 0.0f;

    // Speed PID
    bal_speed_pid.kp = 20.0f;
    bal_speed_pid.ki = 0.25f;
    bal_speed_pid.kd = 1.0f;
    bal_speed_pid.max_out = 2000.0f;
    bal_speed_pid.int_max = 1000.0f;
    bal_speed_pid.error[0] = 0.0f;
    bal_speed_pid.error[1] = 0.0f;
    bal_speed_pid.integral = 0.0f;
}

// Set forward/backward speed
void set_target_speed(float spd)
{
    target_speed = spd;
}

// Compute linear speed from motor RPM
static float get_motor_speed_mps(uint8_t motor_id)
{
	int16_t rpm = g_can_motors[motor_id - 1].raw_data.rpm;
    return rpm * RPM_TO_MS;
}

// Balancing control
void balancing_control(void)
{
    float pitch = imu_heading.pit;

    float gx, gy, gz;
    get_gyro_data(&gx, &gy, &gz);
    float gyro_y = gy;

    // --- Get encoder-based wheel speeds ---
    float left_speed = get_motor_speed_mps(MOTOR_LEFT_ID);
    float right_speed = get_motor_speed_mps(MOTOR_RIGHT_ID);
    current_speed = (left_speed + right_speed) * 0.5f; // m/s average

    // --- Outer loop: Speed PID ---
    bal_speed_pid.error[1] = bal_speed_pid.error[0];
    bal_speed_pid.error[0] = target_speed - current_speed;

    bal_speed_pid.integral += bal_speed_pid.error[0];
    bal_speed_pid.integral = clamp(bal_speed_pid.integral, bal_speed_pid.int_max);

    float pitch_target = bal_speed_pid.kp * bal_speed_pid.error[0]
                       + bal_speed_pid.ki * bal_speed_pid.integral
                       + bal_speed_pid.kd * (bal_speed_pid.error[0] - bal_speed_pid.error[1]);
    pitch_target = clamp(pitch_target, 5.0f); // ±5°

    // --- Inner loop: Angle PID ---
    bal_angle_pid.error[1] = bal_angle_pid.error[0];
    bal_angle_pid.error[0] = pitch_target - pitch;

    balance_output = bal_angle_pid.kp * bal_angle_pid.error[0]
                   + bal_angle_pid.kd * (-gyro_y);

    balance_output = clamp(balance_output, bal_angle_pid.max_out);
}
while (1) {
		start_time = xTaskGetTickCount();
//		speed_pid(30 * 19.2, can_motors[TMOTOR_ID-1].raw_data.rpm, &can_motors[TMOTOR_ID-1].rpm_pid);
//		can_motors[TMOTOR_ID-1].output = can_motors[TMOTOR_ID-1].rpm_pid.output;

//		{
//		            motor_data_t *motor = &g_can_motors[BL_MOTOR_ID-1];
//		            double target_rpm = -200.0;                   // hardcoded target RPM
//		            double current_rpm = motor->raw_data.rpm;    // read current RPM
//		            speed_pid(target_rpm, current_rpm, &motor->rpm_pid);  // PID update
//		            motor->output = motor->rpm_pid.output;       // update motor output
//		        }
//
//		        // ---- FL Motor (CAN ID 2) ----
//		        {
//		            motor_data_t *motor = &g_can_motors[FL_MOTOR_ID-1];
//		            double target_rpm = 200.0;
//		            double current_rpm = motor->raw_data.rpm;
//		            speed_pid(target_rpm, current_rpm, &motor->rpm_pid);
//		            motor->output = motor->rpm_pid.output;
//		        }
//
//		        // Send CAN command (only these two motors)
//		        motor_send_can(g_can_motors, BL_MOTOR_ID, FL_MOTOR_ID, 0, 0);


		balancing_control();
		double target_rpm_left  = get_balance_output();
		double target_rpm_right  = -get_balance_output();

		// --- Motor PID for BL Motor (CAN ID 1) ---
		        {
		            motor_data_t *motor = &g_can_motors[BL_MOTOR_ID - 1];
		            double target_rpm = target_rpm_left;                   // hardcoded target RPM
		            double current_rpm = motor->raw_data.rpm;     // read current RPM
		            speed_pid(target_rpm, current_rpm, &motor->rpm_pid);
		            motor->output = motor->rpm_pid.output;
		        }

		        // --- Motor PID for FL Motor (CAN ID 2) ---
		        {
		            motor_data_t *motor = &g_can_motors[FL_MOTOR_ID - 1];
		            double target_rpm = target_rpm_right;
		            double current_rpm = motor->raw_data.rpm;
		            speed_pid(target_rpm, current_rpm, &motor->rpm_pid);
		            motor->output = motor->rpm_pid.output;
		        }

		        motor_send_can(g_can_motors, BL_MOTOR_ID, FL_MOTOR_ID, 0, 0);



		//CanComm_SendControlPara(0,0,5,1,0);





		//delays task for other tasks to run
		vTaskDelay(1);
	}
        </code></pre>
    </div>  
    
<p> 
Below is the CAN Communication protocol function for the HT8108 Motors used for the joint of the robot. 
It will output a toruqe to the motor, which is what will be needed for LQR Controller in the subsequent development.
</p>Currently it is set up with MIT Controller.
    <div class="code-block">
      <pre><code class="language-c">void CanComm_SendControlPara(float f_p, float f_v, float f_kp, float f_kd, float f_t, int motor_id)
  {
    uint16_t p, v, kp, kd, t;
    uint8_t buf[8];

    LIMIT_MIN_MAX(f_p,  P_MIN,  P_MAX);
    LIMIT_MIN_MAX(f_v,  V_MIN,  V_MAX);
    LIMIT_MIN_MAX(f_kp, KP_MIN, KP_MAX);
    LIMIT_MIN_MAX(f_kd, KD_MIN, KD_MAX);
    LIMIT_MIN_MAX(f_t,  T_MIN,  T_MAX);

    p = float_to_uint(f_p,      P_MIN,  P_MAX,  16);
    v = float_to_uint(f_v,      V_MIN,  V_MAX,  12);
    kp = float_to_uint(f_kp,    KP_MIN, KP_MAX, 12);
    kd = float_to_uint(f_kd,    KD_MIN, KD_MAX, 12);
    t = float_to_uint(f_t,      T_MIN,  T_MAX,  12);

    buf[0] = p>>8;
    buf[1] = p&0xFF;
    buf[2] = v>>4;
    buf[3] = ((v&0xF)<<4)|(kp>>8);
    buf[4] = kp&0xFF;
    buf[5] = kd>>4;
    buf[6] = ((kd&0xF)<<4)|(t>>8);
    buf[7] = t&0xff;


    CanTransmit(buf, sizeof(buf), motor_id);
  }
      </code></pre>
    </div>




</details>



  <h3 class="subsection-title" id="sec-5-8">5.8 Weight Optimisation</h3>
  
<p>

 As implementing both the big-wheel and hubless wheel designs increases the overall robot mass, 
  weight optimisation becomes critical to ensure compliance with competition rule limits. 
  A detailed evaluation and a structured optimisation approach are therefore required moving forward 
  to keep the design both lightweight and mechanically robust.

</p>


<details class="expand-box">
    <summary><strong>Click to expand: Weight Optimisation Evaluation</strong></summary>

    <p>
  Weight optimisation is a critical part of robot design, particularly for mobile systems where 
  performance is strongly affected by inertia, power consumption, and structural loading. The 
  objective is not simply to minimise weight, but to achieve an optimal balance between mass, 
  stiffness, durability, and functional performance.
</p>

<h4>General Approach to Mechanical Weight Optimisation</h4>

<p>The standard engineering workflow typically involves the following steps:</p>

<ul>
  <li><strong>1. Define weight targets</strong><br>
      Establish a practical mass budget based on competition rules, motor capabilities, and 
      performance requirements (acceleration, step-climbing torque, maneuverability).
  </li>

  <li><strong>2. Identify weight-critical subsystems</strong><br>
      Components such as the chassis frame, wheel-leg assembly, linkages, and gimbal 
      are usually the largest contributors to mass. These areas are prioritised for optimisation.
  </li>

  <li><strong>3. Apply structural optimisation techniques</strong><br>
    Common methods include:
    <ul>
      <li><em>Topology optimisation</em>: remove low-stress regions identified through FEA.</li>
      <li><em>Material substitution</em>: replace aluminium/steel with composites or high-strength polymers.</li>
      <li><em>Geometry refinement</em>: convert solid components into ribs, shells, or trusses.</li>
      <li><em>Load-path design</em>: ensure mass is concentrated along principal stress lines.</li>
    </ul>
  </li>

  <li><strong>4. Validate using Finite Element Analysis (FEA)</strong><br>
      Simulate bending, torsion, impact, and cyclic loading to ensure the optimised part still 
      meets strength and safety-factor requirements.
  </li>

  <li><strong>5. Perform iterative refinement</strong><br>
      Adjust dimensions, cutouts, wall thickness, or reinforcement ribs based on FEA results 
      until the component reaches an acceptable balance of mass and stiffness.
  </li>
</ul>

<h4>Threshold for Optimisation</h4>

<ul>
  <li>Mass exceeds the target weight budget for the subsystem, or</li>
  <li>The component contributes significantly to inertia and reduces dynamic performance, or</li>
  <li>The weight compromises functionality such as step-climbing, acceleration, or gimbal behavior.</li>
</ul>

<h4>Application to This Project</h4>

<p>
  For this robot, weight optimisation will focus on:
</p>

<ul>
  <li>Reducing mass in the wheel-leg assembly without compromising step-climbing stiffness</li>
  <li>Optimising the linkage thickness and geometry through FEA-driven cutouts</li>
  <li>Evaluating the hubless wheel frame for ribbed-shell or lattice structures</li>
  <li>Minimising chassis overdesign while maintaining rigidity for gimbal aiming</li>
  <li>Rebalancing weight distribution to maintain stability during stepping and landing</li>
</ul>

<p>
  Moving forward, each mechanical subsystem will undergo a structured optimisation cycle 
  involving material review, topology optimisation, and simulation verification. This ensures 
  the robot meets performance requirements while staying within the mass limitations imposed 
  by the competition and the available motor capabilities.
</p>

</details>





</section>

